<div class="w-full max-w-7xl mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold mb-4">Your Degree Plan</h1>

  <p class="text-gray-600 mb-6">
    This plan shows the optimal order to complete your remaining subjects based on prerequisites.
    Each semester contains up to 4 subjects.
  </p>

  <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded">
    <p class="font-bold">Plan Generated!</p>
    <p>Starting <%= @start_semester == "1" ? "Semester 1" : "Semester 2" %>, <%= @start_year %></p>
    <div class="mt-2">
      <% required_cp = @course.name.include?("Information Technology") ? 288 : 384 %>
      <p><strong>Completed:</strong> <%= @total_completed_cp %> CP</p>
      <p><strong>Planned:</strong> <%= @total_planned_cp %> CP</p>
      <p><strong>Total:</strong> <%= @total_cp %> / <%= required_cp %> CP
        <% if @total_cp < required_cp %>
          <span class="text-red-700">(Need <%= required_cp - @total_cp %> more CP)</span>
        <% elsif @total_cp > required_cp %>
          <span class="text-yellow-700">(<%= @total_cp - required_cp %> CP over requirement)</span>
        <% else %>
          <span class="text-green-900">âœ“ Complete!</span>
        <% end %>
      </p>
    </div>
  </div>

  <% if @completed_subjects.any? %>
    <%= form_with url: degree_planner_submit_step1_path, method: :post, data: { turbo: false } do |form| %>
      <%= hidden_field_tag 'completed_subject_ids[]', '' %>
      <% @completed_subject_ids.each do |id| %>
        <%= hidden_field_tag 'completed_subject_ids[]', id %>
      <% end %>
      <%= hidden_field_tag 'want_to_complete_ids[]', '' %>
      <% @want_to_complete_ids.each do |id| %>
        <%= hidden_field_tag 'want_to_complete_ids[]', id %>
      <% end %>
      <%= hidden_field_tag 'difficulty', @difficulty %>
      <%= hidden_field_tag 'start_year', @start_year %>
      <%= hidden_field_tag 'start_semester', @start_semester %>

      <div style="background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <h2 style="font-size: 20px; font-weight: bold; color: #374151; margin: 0;">âœ“ Completed Subjects</h2>
            <p style="font-size: 14px; color: #6b7280; margin-top: 4px;">
              Click on a card to select/update the grade for each subject.
            </p>
          </div>
          <div style="display: flex; gap: 16px; align-items: center;">
            <button type="submit" style="background-color: #7c3aed !important; color: white !important; padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 14px; border: none; cursor: pointer;">
              ðŸ’¾ Save Grades
            </button>
            <% if @gpa %>
              <div style="background-color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Current GPA</div>
                <div style="font-size: 32px; font-weight: bold; color: #7c3aed;"><%= @gpa %></div>
                <div style="font-size: 12px; color: #6b7280;">out of 7.0</div>
              </div>
            <% end %>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 16px;">
          <% @completed_subjects.sort_by(&:code).each do |subject| %>
            <% grade = @grades[subject.id.to_s] %>
            <div style="background-color: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <div style="font-family: monospace; font-weight: bold; color: #1e40af; font-size: 14px; margin-bottom: 8px;">
                <%= subject.code %>
              </div>
              <%= select_tag "grades[#{subject.id}]",
                  options_for_select([
                    ['No grade', ''],
                    ['7 - HD (85-100%)', '7'],
                    ['6 - D (75-84%)', '6'],
                    ['5 - C (65-74%)', '5'],
                    ['4 - P (50-64%)', '4'],
                    ['S - Satisfactory', 'S'],
                    ['3 - Marginal Fail', '3'],
                    ['2 - Fail', '2'],
                    ['1 - Low Fail', '1'],
                    ['K - Withdrawn', 'K'],
                    ['U - Unsatisfactory', 'U'],
                    ['E - Exempt', 'E'],
                    ['A - Unfinalised', 'A'],
                    ['SA - Supp. Assessment', 'SA'],
                    ['DA - Deferred', 'DA'],
                    ['T - Continues', 'T']
                  ], grade || ''),
                  style: "width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-top: 4px;" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if @semester_plan.any? %>
    <div style="background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
          <colgroup>
            <col style="width: 150px;">
            <col style="width: 100px;">
            <col style="width: auto;">
            <col style="width: 200px;">
            <col style="width: 100px;">
            <col style="width: 60px;">
          </colgroup>
          <thead style="background-color: #f9fafb; border-bottom: 2px solid #e5e7eb;">
            <tr>
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Semester</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Code</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Unit Name</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Prerequisites</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Type</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">CP</th>
            </tr>
          </thead>
          <tbody>
            <% @semester_plan.each_with_index do |semester_data, index| %>
              <% semester_data[:subjects].each_with_index do |subject, subj_index| %>
                <tr style="border-bottom: 1px solid #e5e7eb; <%= 'background-color: #f9fafb;' if index.even? %>">
                  <% if subj_index == 0 %>
                    <td rowspan="<%= semester_data[:subjects].count %>" style="padding: 12px; font-weight: bold; vertical-align: top; border-right: 2px solid #e5e7eb;">
                      <div style="font-size: 14px; color: #7c3aed;">Year <%= semester_data[:year] %></div>
                      <div style="font-size: 16px; margin-top: 4px;">Semester <%= semester_data[:semester] %></div>
                      <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        <%= semester_data[:subjects].count %> units<br>
                        <%= semester_data[:subjects].sum { |s| s.credit_points || 0 } %> CP
                      </div>
                    </td>
                  <% end %>
                  <td style="padding: 12px;">
                    <span style="display: inline-block; padding: 4px 8px; background-color: #dbeafe; color: #1e40af; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">
                      <%= subject.code %>
                    </span>
                  </td>
                  <td style="padding: 12px;">
                    <div style="font-weight: 500;"><%= subject.name %></div>
                  </td>
                  <td style="padding: 12px; font-size: 12px; color: #6b7280;">
                    <% if subject.prerequisites.present? %>
                      <%= subject.prerequisites %>
                    <% else %>
                      <span style="color: #9ca3af;">None</span>
                    <% end %>
                  </td>
                  <td style="padding: 12px; font-size: 11px;">
                    <span style="display: inline-block; padding: 2px 6px; background-color: #fef3c7; color: #92400e; border-radius: 4px; font-weight: 500;">
                      <%= subject.unit_type %>
                    </span>
                  </td>
                  <td style="padding: 12px; text-align: center; font-weight: 500;">
                    <%= subject.credit_points %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-center mb-4">Degree Summary</h3>
      <div class="grid grid-cols-3 gap-6 max-w-2xl mx-auto">
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600"><%= @semester_plan.count %></div>
          <div class="text-sm text-gray-600">Semesters</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600">
            <%= @semester_plan.sum { |s| s[:subjects].count } %>
          </div>
          <div class="text-sm text-gray-600">Total Subjects</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600">
            <%= @semester_plan.sum { |s| s[:subjects].sum { |subj| subj.credit_points || 0 } } %>
          </div>
          <div class="text-sm text-gray-600">Total Credit Points</div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
      <p class="font-bold">No subjects to schedule</p>
      <p>You may have completed all subjects or there might be an issue with prerequisites.</p>
    </div>
  <% end %>

  <div class="mt-6">
    <%= link_to "â† Start Over", degree_planner_step1_path, class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg" %>
  </div>
</div>
